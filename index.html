<!DOCTYPE html>
<html>
    <head>
        <title>RPG Chart</title>
        <meta charset="UTF-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <link rel="stylesheet" href="./css/pure-min.css"/>
        <link rel="stylesheet" href="./css/grids-responsive-min.css"/>
        <link rel="stylesheet" href="./css/main.css"/>
        <style>
            .link {
                stroke: #ccc;
                stroke-width: 1px;
            }

            .node {
                stroke: #fff;
                stroke-width: 2px;
            }

            .textClass {
                stroke: #323232;
                font-family: "Lucida Grande", "Droid Sans", Arial, Helvetica, sans-serif;
                font-weight: normal;
                stroke-width: .5;
                font-size: 18px;
            }
        </style>
    </head>
    <body>
        <button onclick="ajoute()">add</button>
        <script src="./js/riot+compiler.min.js"></script>
        <script src="./js/d3.min.js"></script>

        <script src="./tag/spa.tag" type="riot/tag"></script>
        <script src="./tag/my-footer.tag" type="riot/tag"></script>

        <script>
            var graph;
            function myGraph() {

                // Add and remove elements on the graph object
                this.addNode = function (id) {
                    nodes.push({"id": id});
                    update();
                };

                this.removeNode = function (id) {
                    var i = 0;
                    var n = findNode(id);
                    while (i < links.length) {
                        if ((links[i]['source'] == n) || (links[i]['target'] == n)) {
                            links.splice(i, 1);
                        }
                        else
                            i++;
                    }
                    nodes.splice(findNodeIndex(id), 1);
                    update();
                };

                this.removeLink = function (source, target) {
                    for (var i = 0; i < links.length; i++) {
                        if (links[i].source.id == source && links[i].target.id == target) {
                            links.splice(i, 1);
                            break;
                        }
                    }
                    update();
                };

                this.removeallLinks = function () {
                    links.splice(0, links.length);
                    update();
                };

                this.removeAllNodes = function () {
                    nodes.splice(0, links.length);
                    update();
                };

                this.addLink = function (source, target, value) {
                    links.push({"source": findNode(source), "target": findNode(target), "value": value});
                    update();
                };

                var findNode = function (id) {
                    for (var i in nodes) {
                        if (nodes[i]["id"] === id)
                            return nodes[i];
                    }
                    ;
                };

                var findNodeIndex = function (id) {
                    for (var i = 0; i < nodes.length; i++) {
                        if (nodes[i].id == id) {
                            return i;
                        }
                    }
                    ;
                };

                // set up the D3 visualisation in the specified element
                var w = 960,
                        h = 450;

                var color = d3.scale.category10();

                var vis = d3.select("body")
                        .append("svg:svg")
                        .attr("width", w)
                        .attr("height", h)
                        .attr("id", "svg")
                        .attr("pointer-events", "all")
                        .attr("viewBox", "0 0 " + w + " " + h)
                        .attr("perserveAspectRatio", "xMinYMid")
                        .append('svg:g');

                vis.append('defs').append('marker')
                        .attr({'id': 'arrowhead',
                            'viewBox': '-0 -5 10 10',
                            'refX': 25,
                            'refY': 0,
                            'orient': 'auto',
                            'markerWidth': 10,
                            'markerHeight': 10,
                            'xoverflow': 'visible'})
                        .append('svg:path')
                        .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
                        .attr('fill', '#ccc')
                        .attr('stroke', '#ccc');

                vis.append("g").attr("id", "links-layer")
                vis.append("g").attr("id", "nodes-layer")

                var force = d3.layout.force();

                var nodes = force.nodes(),
                        links = force.links();

                var update = function () {
                    var link = vis.select('#links-layer').selectAll("line")
                            .data(links, function (d) {
                                return d.source.id + "-" + d.target.id;
                            });

                    link.enter().append("line")
                            .attr("id", function (d) {
                                return d.source.id + "-" + d.target.id;
                            })
                            .attr("class", "link")
                            .attr('marker-end', 'url(#arrowhead)')

                    link.exit().remove();

                    var edgepaths = vis.selectAll(".edgepath")
                            .data(links, function (d) {
                                return 'edgepath-' + d.source.id + "-" + d.target.id;
                            });

                    edgepaths.enter()
                            .append('path')
                            .attr({'d': function (d) {
                                    return 'M ' + d.source.x + ' ' + d.source.y + ' L ' + d.target.x + ' ' + d.target.y
                                },
                                'class': 'edgepath',
                                'fill-opacity': 0,
                                'stroke-opacity': 0,
                                'fill': 'blue',
                                'stroke': 'red',
                                'id': function (d, i) {
                                    return 'edgepath-' + d.source.id + "-" + d.target.id;
                                }})
                            .style("pointer-events", "none");
                    edgepaths.exit().remove();

                    var edgelabels = vis.selectAll(".edgelabel")
                            .data(links, function (d) {
                                return 'edgelabel-' + d.source.id + "-" + d.target.id;
                            })

                    edgelabels.enter()
                            .append('text')
                            .style("pointer-events", "none")
                            .attr({'class': 'edgelabel',
                                'id': function (d, i) {
                                    return 'edgelabel-' + d.source.id + "-" + d.target.id;
                                },
                                'dx': 50,
                                'dy': 0,
                                'font-size': 10,
                                'fill': '#777'})
                            .append('textPath')
                            .attr('xlink:href', function (d, i) {
                                return '#edgepath-' + d.source.id + "-" + d.target.id;
                            })
                            .style("pointer-events", "none")
                            .text(function (d) {
                                return d.value
                            });
                    edgelabels.exit().remove()

                    var node = vis.select('#nodes-layer').selectAll("g.node")
                            .data(nodes, function (d) {
                                return d.id;
                            });

                    var nodeEnter = node.enter().append("g")
                            .attr("class", "node")
                            .call(force.drag);

                    nodeEnter.append("svg:circle")
                            .attr("r", 15)
                            .attr("id", function (d) {
                                return "Node;" + d.id;
                            })
                            .attr("class", "nodeStrokeClass")
                            .attr("fill", function (d) {
                                return color(d.id);
                            });

                    nodeEnter.append("svg:text")
                            .attr("class", "textClass")
                            .attr("x", 0)
                            .attr("y", 0)
                            .text(function (d) {
                                return d.id;
                            });

                    node.exit().remove();

                    force.on("tick", function () {

                        node.attr("transform", function (d) {
                            return "translate(" + d.x + "," + d.y + ")";
                        });

                        link.attr("x1", function (d) {
                            return d.source.x;
                        })
                                .attr("y1", function (d) {
                                    return d.source.y;
                                })
                                .attr("x2", function (d) {
                                    return d.target.x;
                                })
                                .attr("y2", function (d) {
                                    return d.target.y;
                                });

                        edgepaths.attr('d', function (d) {
                            return 'M ' + d.source.x + ' ' + d.source.y + ' L ' + d.target.x + ' ' + d.target.y;
                        });

                        edgelabels.attr('transform', function (d) {
                            if (d.target.x < d.source.x) {
                                bbox = this.getBBox();
                                rx = bbox.x + bbox.width / 2;
                                ry = bbox.y + bbox.height / 2;
                                return 'rotate(180 ' + rx + ' ' + ry + ')';
                            }
                            else {
                                return 'rotate(0)';
                            }
                        });
                    });

                    // Restart the force layout.
                    force
                            .gravity(0.05)
                            .charge(-500)
                            .theta(0.1)
                            .linkDistance(function (d) {
                                return 130
                            })
                            .size([w, h])
                            .start();
                };

                // Make it all go
                update();
            }

            function drawGraph() {

                graph = new myGraph("#svgdiv");

                graph.addNode('Sophia');
                graph.addNode('Daniel');
                graph.addNode('Ryan');
                graph.addNode('Lila');
                graph.addNode('Suzie');
                graph.addNode('Riley');
                graph.addNode('Grace');
                graph.addNode('Dylan');
                graph.addNode('Mason');
                graph.addNode('Emma');
                graph.addNode('Alex');
                graph.addLink('Alex', 'Ryan', 'ami');
                graph.addLink('Sophia', 'Ryan', 'stalke');
                graph.addLink('Daniel', 'Ryan', 'enemi');
                graph.addLink('Ryan', 'Lila', 'surveille');
                graph.addLink('Lila', 'Suzie', 'boz');
                graph.addLink('Suzie', 'Riley', 'couille');
                graph.addLink('Suzie', 'Grace', 'fait partie');
                graph.addLink('Grace', 'Dylan', 'wesh');
                graph.addLink('Dylan', 'Mason', 'truc');
                graph.addLink('Dylan', 'Emma', 'boz boz');
                graph.addLink('Emma', 'Mason', 'tei');

                // callback for the changes in the network
                var step = -1;
                function nextval()
                {
                    step++;
                    return 5000 + (1500 * step); // initial time, wait time
                }

                setTimeout(function () {
                    graph.addLink('Alex', 'Sophia', '20');
                }, nextval());

                setTimeout(function () {
                    graph.addLink('Sophia', 'Daniel', '20');
                }, nextval());

                setTimeout(function () {
                    graph.addLink('Daniel', 'Alex', '20');
                }, nextval());

                setTimeout(function () {
                    graph.addLink('Suzie', 'Daniel', '30');
                }, nextval());

                setTimeout(function () {
                    graph.removeLink('Dylan', 'Mason');
                    graph.addLink('Dylan', 'Mason', '8');
                }, nextval());

                setTimeout(function () {
                    graph.removeLink('Dylan', 'Emma');
                    graph.addLink('Dylan', 'Emma', '8');
                }, nextval());

            }

            drawGraph();

        </script>
    </body>
</html>
